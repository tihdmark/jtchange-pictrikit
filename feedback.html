<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Feedback & Official Responses - PictriKit</title>
  <meta name="description" content="Read user feedback, feature requests, and official responses from the PictriKit team. Share your suggestions and see how we respond to community input.">
  <link rel="canonical" href="https://www.pictrikit.com/feedback.html">
  <meta property="og:title" content="User Feedback & Official Responses - PictriKit">
  <meta property="og:description" content="Community feedback and official responses from PictriKit. Share your thoughts and see our replies.">
  <meta property="og:url" content="https://www.pictrikit.com/feedback.html">
  <meta property="og:type" content="website">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #f8fafc; color: #334155; line-height: 1.6; min-height: 100vh; }
    .container { max-width: 720px; margin: 0 auto; padding: 0 1rem; }
    header { background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }
    header .container { display: flex; justify-content: space-between; align-items: center; height: 64px; }
    .logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; }
    .logo .material-icons-round { color: #007AFF; font-size: 1.75rem; }
    .logo span { font-weight: 700; font-size: 1.125rem; color: #111827; }
    .back-link { color: #6b7280; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem; }
    .back-link:hover { color: #007AFF; }
    main { padding: 3rem 0 4rem; }
    h1 { font-size: 1.75rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; }
    .page-intro { color: #4b5563; margin-bottom: 2rem; font-size: 0.9375rem; line-height: 1.7; }
    .page-header { margin-bottom: 2rem; }
    .form-heading { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; }
    .admin-badge { display: inline-flex; align-items: center; gap: 0.25rem; background: #fef3c7; color: #92400e; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
    .feedback-form { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e5e7eb; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
    .form-textarea { width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; font-family: inherit; resize: vertical; outline: none; transition: border-color 0.2s; }
    .form-textarea:focus { border-color: #007AFF; }
    .form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
    .char-count { font-size: 0.75rem; color: #9ca3af; }
    .submit-btn { padding: 0.625rem 1.25rem; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s; }
    .submit-btn:hover { background: #0066DD; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .feedback-list-section { margin-top: 2.5rem; }
    .messages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .messages-title { font-size: 1.125rem; font-weight: 600; color: #374151; margin: 0; }
    .messages-count { font-size: 0.75rem; color: #9ca3af; }
    .message-card { background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
    .message-card.deleted { opacity: 0.5; background: #fef2f2; }
    .message-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .message-user { display: flex; align-items: center; gap: 0.5rem; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #007AFF, #5856D6); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600; }
    .user-name { font-weight: 500; color: #6b7280; font-size: 0.8125rem; margin: 0; }
    .message-time { font-size: 0.75rem; color: #9ca3af; }
    .message-body { margin-bottom: 0.5rem; }
    .message-content { color: #1f2937; font-size: 0.9375rem; line-height: 1.7; margin: 0; white-space: pre-wrap; }
    .admin-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6; }
    .admin-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; transition: all 0.2s; }
    .admin-btn .material-icons-round { font-size: 14px; }
    .admin-btn.reply-btn { background: #eff6ff; color: #1d4ed8; }
    .admin-btn.reply-btn:hover { background: #dbeafe; }
    .admin-btn.delete-btn { background: #fef2f2; color: #dc2626; }
    .admin-btn.delete-btn:hover { background: #fee2e2; }
    .admin-reply-form { margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .admin-reply-form textarea { width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.8125rem; font-family: inherit; resize: vertical; outline: none; }
    .admin-reply-form textarea:focus { border-color: #007AFF; }
    .admin-reply-form-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; }
    .admin-reply-form-actions button { padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 6px; cursor: pointer; border: none; }
    .admin-reply-form-actions .cancel-btn { background: #f3f4f6; color: #6b7280; }
    .admin-reply-form-actions .save-btn { background: #007AFF; color: white; }
    .admin-reply-form-actions .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .reply-card { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #007AFF; margin-top: 1rem; padding: 1rem 1.25rem; border-radius: 0 8px 8px 0; }
    .reply-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.625rem; }
    .creator-badge { background: #007AFF; color: white; font-size: 0.625rem; font-weight: 700; padding: 0.1875rem 0.5rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.025em; }
    .reply-name { font-weight: 600; color: #0369a1; font-size: 0.875rem; margin: 0; }
    .reply-content { color: #0c4a6e; font-size: 0.9375rem; line-height: 1.7; margin: 0; white-space: pre-wrap; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #9ca3af; }
    .empty-state .material-icons-round { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .loading { text-align: center; padding: 2rem; color: #9ca3af; }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #111827; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.875rem; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; }
    .toast.error { background: #dc2626; }
    footer { background: #111827; color: white; padding: 2rem 0; margin-top: auto; }
    footer .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    footer a { color: #9ca3af; text-decoration: none; font-size: 0.875rem; }
    footer a:hover { color: white; }
    @media (max-width: 640px) {
      h1 { font-size: 1.5rem; }
      .message-header { flex-direction: column; gap: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <a href="/" class="logo">
        <span class="material-icons-round">dashboard_customize</span>
        <span>PictriKit</span>
      </a>
      <a href="/app.html" class="back-link">
        <span class="material-icons-round" style="font-size:18px;">arrow_back</span>
        Back to Editor
      </a>
    </div>
  </header>

  <main>
    <div class="container">
      <header class="page-header">
        <h1>User Feedback & Official Responses<span class="admin-badge" id="admin-badge" style="display:none;"><span class="material-icons-round" style="font-size:12px;">admin_panel_settings</span>Admin Mode</span></h1>
        <p class="page-intro">This page collects feedback, suggestions, and bug reports from PictriKit users. Each message may include an official response from our team. We read every submission and respond when we can help or when updates are planned.</p>
      </header>
      
      <section class="feedback-form" aria-label="Submit your feedback">
        <h2 class="form-heading">Share Your Feedback</h2>
        <label class="form-label" for="feedback-input">Your message</label>
        <textarea class="form-textarea" id="feedback-input" rows="4" maxlength="1000" placeholder="Describe your suggestion, question, or issue..."></textarea>
        <div class="form-footer">
          <span class="char-count"><span id="char-count">0</span> / 1000</span>
          <button class="submit-btn" id="submit-btn">Send Feedback</button>
        </div>
      </section>
      
      <section class="feedback-list-section" aria-label="User feedback and responses">
        <header class="messages-header">
          <h2 class="messages-title">Community Feedback</h2>
          <span class="messages-count" id="messages-count"></span>
        </header>
        <div id="messages-list" role="feed" aria-label="Feedback messages">
          <p class="loading">Loading messages...</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <span style="font-size:0.875rem;color:#9ca3af;">&copy; 2026 PictriKit</span>
      <div style="display:flex;gap:1.5rem;">
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="/contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM
    var messagesList = document.getElementById('messages-list');
    var messagesCount = document.getElementById('messages-count');
    var adminBadge = document.getElementById('admin-badge');
    var input = document.getElementById('feedback-input');
    var charCount = document.getElementById('char-count');
    var submitBtn = document.getElementById('submit-btn');
    var toast = document.getElementById('toast');

    // State
    var isAdmin = false;
    var adminToken = null;
    var feedbackData = [];

    // Utils
    function showToast(msg, err) {
      toast.textContent = msg;
      toast.className = 'toast show' + (err ? ' error' : '');
      setTimeout(function() { toast.className = 'toast'; }, 3000);
    }

    function esc(s) {
      var d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function timeAgo(ts) {
      if (!ts) return '';
      var d = new Date(ts), now = new Date(), diff = now - d;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
      return d.toLocaleDateString('en-US', {month:'short',day:'numeric'});
    }

    function getUserId() {
      var id = localStorage.getItem('pictrikit_user_id');
      if (!id) {
        var adj = ['Happy','Swift','Clever','Bright','Cool'];
        var noun = ['Panda','Eagle','Tiger','Fox','Wolf'];
        id = adj[Math.floor(Math.random()*5)] + noun[Math.floor(Math.random()*5)] + Math.floor(Math.random()*1000);
        localStorage.setItem('pictrikit_user_id', id);
      }
      return id;
    }

    // Admin Mode (独立，不依赖 fetch)
    function initAdminMode() {
      console.log('[Admin] initAdminMode called');
      
      // 1. 检查 URL 参数
      var url = new URLSearchParams(window.location.search);
      var t = url.get('admin');
      console.log('[Admin] URL token:', t ? 'present' : 'none');
      
      if (t) {
        localStorage.setItem('pictrikit_admin_token', t);
        history.replaceState({}, '', location.pathname);
        console.log('[Admin] Token saved to localStorage');
      }
      
      // 2. 从 localStorage 读取
      adminToken = localStorage.getItem('pictrikit_admin_token');
      console.log('[Admin] localStorage token:', adminToken ? ('found: ' + adminToken.substring(0,4) + '...') : 'none');
      
      // 3. 启用 Admin Mode
      if (adminToken && adminToken.length > 0) {
        isAdmin = true;
        document.body.classList.add('admin-mode');
        if (adminBadge) {
          adminBadge.style.display = 'inline-flex';
        }
        console.log('[Admin] Admin mode ENABLED');
      } else {
        console.log('[Admin] Admin mode disabled (no token)');
      }
    }

    // Render
    function renderFeedback(list) {
      feedbackData = list;
      if (!list || list.length === 0) {
        messagesList.innerHTML = '<div class="empty-state"><span class="material-icons-round">chat_bubble_outline</span><p>No messages yet.</p></div>';
        messagesCount.textContent = '';
        return;
      }
      messagesCount.textContent = list.length + ' message' + (list.length > 1 ? 's' : '');
      var html = '';
      for (var i = 0; i < list.length; i++) {
        var m = list[i];
        var initials = (m.username || 'AN').slice(0,2).toUpperCase();
        var replyHtml = m.reply ? '<aside class="reply-card"><header class="reply-header"><span class="creator-badge">Official</span><h4 class="reply-name">PictriKit Team</h4></header><p class="reply-content">' + esc(m.reply) + '</p></aside>' : '';
        var adminHtml = isAdmin ? '<div class="admin-actions"><button class="admin-btn reply-btn" data-id="' + m.id + '"><span class="material-icons-round">reply</span>' + (m.reply ? 'Edit' : 'Reply') + '</button><button class="admin-btn delete-btn" data-id="' + m.id + '"><span class="material-icons-round">delete</span>Delete</button></div>' : '';
        html += '<article class="message-card" data-id="' + m.id + '"><header class="message-header"><div class="message-user"><div class="user-avatar">' + initials + '</div><h3 class="user-name">' + esc(m.username) + '</h3></div><time class="message-time">' + timeAgo(m.created_at) + '</time></header><div class="message-body"><p class="message-content">' + esc(m.content) + '</p></div>' + replyHtml + adminHtml + '</article>';
      }
      messagesList.innerHTML = html;
      bindAdminEvents();
    }

    function bindAdminEvents() {
      if (!isAdmin) return;
      var rBtns = messagesList.querySelectorAll('.reply-btn');
      var dBtns = messagesList.querySelectorAll('.delete-btn');
      for (var i = 0; i < rBtns.length; i++) {
        rBtns[i].onclick = function() { openReplyForm(this.dataset.id); };
      }
      for (var j = 0; j < dBtns.length; j++) {
        dBtns[j].onclick = function() { doDelete(this.dataset.id); };
      }
    }

    function openReplyForm(id) {
      var card = document.querySelector('[data-id="' + id + '"]');
      if (!card || card.querySelector('.admin-reply-form')) return;
      var item = feedbackData.find(function(x) { return x.id === id; });
      var form = document.createElement('div');
      form.className = 'admin-reply-form';
      form.innerHTML = '<textarea rows="3" maxlength="2000">' + esc(item && item.reply || '') + '</textarea><div class="admin-reply-form-actions"><button class="cancel-btn">Cancel</button><button class="save-btn">Save</button></div>';
      form.querySelector('.cancel-btn').onclick = function() { form.remove(); };
      form.querySelector('.save-btn').onclick = function() {
        var txt = form.querySelector('textarea').value.trim();
        fetch('/api/feedback', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
          body: JSON.stringify({ feedbackId: id, reply: txt || null })
        }).then(function(r) {
          if (r.ok) { showToast('Saved'); initFeedback(); }
          else showToast('Failed', true);
        });
      };
      card.appendChild(form);
    }

    function doDelete(id) {
      if (!confirm('Delete?')) return;
      fetch('/api/feedback', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
        body: JSON.stringify({ feedbackId: id })
      }).then(function(r) {
        if (r.ok) { showToast('Deleted'); initFeedback(); }
        else showToast('Failed', true);
      });
    }

    // Submit
    input.oninput = function() { charCount.textContent = input.value.length; };
    submitBtn.onclick = function() {
      var c = input.value.trim();
      if (c.length < 3) { showToast('Min 3 chars', true); return; }
      submitBtn.disabled = true;
      fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: c, username: getUserId() })
      }).then(function(r) { return r.json(); }).then(function(d) {
        submitBtn.disabled = false;
        if (d.success) { showToast('Thanks!'); input.value = ''; charCount.textContent = '0'; initFeedback(); }
        else showToast(d.error || 'Failed', true);
      }).catch(function() { submitBtn.disabled = false; showToast('Error', true); });
    };

    // Init
    async function initFeedback() {
      var res = await fetch('/api/feedback?_t=' + Date.now());
      var data = await res.json();
      if (!data.success) {
        messagesList.innerHTML = '<p class="empty-state">Failed to load</p>';
        return;
      }
      renderFeedback(data.feedback);
    }

    // Start
    initAdminMode();
    initFeedback();
  });
  </script>
</body>
</html>
