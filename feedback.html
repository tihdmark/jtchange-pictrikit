<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Feedback & Official Responses - PictriKit</title>
  <meta name="description" content="Read user feedback, feature requests, and official responses from the PictriKit team. Share your suggestions and see how we respond to community input.">
  <link rel="canonical" href="https://www.pictrikit.com/feedback.html">
  <meta property="og:title" content="User Feedback & Official Responses - PictriKit">
  <meta property="og:description" content="Community feedback and official responses from PictriKit. Share your thoughts and see our replies.">
  <meta property="og:url" content="https://www.pictrikit.com/feedback.html">
  <meta property="og:type" content="website">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #f8fafc; color: #334155; line-height: 1.6; min-height: 100vh; }
    .container { max-width: 720px; margin: 0 auto; padding: 0 1rem; }
    header { background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }
    header .container { display: flex; justify-content: space-between; align-items: center; height: 64px; }
    .logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; }
    .logo .material-icons-round { color: #007AFF; font-size: 1.75rem; }
    .logo span { font-weight: 700; font-size: 1.125rem; color: #111827; }
    .back-link { color: #6b7280; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem; }
    .back-link:hover { color: #007AFF; }
    main { padding: 3rem 0 4rem; }
    h1 { font-size: 1.75rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; }
    .page-intro { color: #4b5563; margin-bottom: 2rem; font-size: 0.9375rem; line-height: 1.7; }
    .page-header { margin-bottom: 2rem; }
    .form-heading { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; }
    .admin-badge { display: inline-flex; align-items: center; gap: 0.25rem; background: #fef3c7; color: #92400e; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
    .feedback-form { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e5e7eb; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
    .form-textarea { width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; font-family: inherit; resize: vertical; outline: none; transition: border-color 0.2s; }
    .form-textarea:focus { border-color: #007AFF; }
    .form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
    .char-count { font-size: 0.75rem; color: #9ca3af; }
    .submit-btn { padding: 0.625rem 1.25rem; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s; }
    .submit-btn:hover { background: #0066DD; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .feedback-list-section { margin-top: 2.5rem; }
    .messages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .messages-title { font-size: 1.125rem; font-weight: 600; color: #374151; margin: 0; }
    .messages-count { font-size: 0.75rem; color: #9ca3af; }
    .message-card { background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
    .message-card.deleted { opacity: 0.5; background: #fef2f2; }
    .message-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .message-user { display: flex; align-items: center; gap: 0.5rem; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #007AFF, #5856D6); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600; }
    .user-name { font-weight: 500; color: #6b7280; font-size: 0.8125rem; margin: 0; }
    .message-time { font-size: 0.75rem; color: #9ca3af; }
    .message-body { margin-bottom: 0.5rem; }
    .message-content { color: #1f2937; font-size: 0.9375rem; line-height: 1.7; margin: 0; white-space: pre-wrap; }
    .admin-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6; }
    .admin-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; transition: all 0.2s; }
    .admin-btn .material-icons-round { font-size: 14px; }
    .admin-btn.reply-btn { background: #eff6ff; color: #1d4ed8; }
    .admin-btn.reply-btn:hover { background: #dbeafe; }
    .admin-btn.delete-btn { background: #fef2f2; color: #dc2626; }
    .admin-btn.delete-btn:hover { background: #fee2e2; }
    .admin-reply-form { margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .admin-reply-form textarea { width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.8125rem; font-family: inherit; resize: vertical; outline: none; }
    .admin-reply-form textarea:focus { border-color: #007AFF; }
    .admin-reply-form-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; }
    .admin-reply-form-actions button { padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 6px; cursor: pointer; border: none; }
    .admin-reply-form-actions .cancel-btn { background: #f3f4f6; color: #6b7280; }
    .admin-reply-form-actions .save-btn { background: #007AFF; color: white; }
    .admin-reply-form-actions .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .reply-card { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #007AFF; margin-top: 1rem; padding: 1rem 1.25rem; border-radius: 0 8px 8px 0; }
    .reply-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.625rem; }
    .creator-badge { background: #007AFF; color: white; font-size: 0.625rem; font-weight: 700; padding: 0.1875rem 0.5rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.025em; }
    .reply-name { font-weight: 600; color: #0369a1; font-size: 0.875rem; margin: 0; }
    .reply-content { color: #0c4a6e; font-size: 0.9375rem; line-height: 1.7; margin: 0; white-space: pre-wrap; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #9ca3af; }
    .empty-state .material-icons-round { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .loading { text-align: center; padding: 2rem; color: #9ca3af; }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #111827; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.875rem; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; }
    .toast.error { background: #dc2626; }
    footer { background: #111827; color: white; padding: 2rem 0; margin-top: auto; }
    footer .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    footer a { color: #9ca3af; text-decoration: none; font-size: 0.875rem; }
    footer a:hover { color: white; }
    @media (max-width: 640px) {
      h1 { font-size: 1.5rem; }
      .message-header { flex-direction: column; gap: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <a href="/" class="logo">
        <span class="material-icons-round">dashboard_customize</span>
        <span>PictriKit</span>
      </a>
      <a href="/app.html" class="back-link">
        <span class="material-icons-round" style="font-size:18px;">arrow_back</span>
        Back to Editor
      </a>
    </div>
  </header>

  <main>
    <div class="container">
      <header class="page-header">
        <h1>User Feedback & Official Responses<span class="admin-badge" id="admin-badge" style="display:none;"><span class="material-icons-round" style="font-size:12px;">admin_panel_settings</span>Admin Mode</span></h1>
        <p class="page-intro">This page collects feedback, suggestions, and bug reports from PictriKit users. Each message may include an official response from our team. We read every submission and respond when we can help or when updates are planned.</p>
      </header>
      
      <section class="feedback-form" aria-label="Submit your feedback">
        <h2 class="form-heading">Share Your Feedback</h2>
        <label class="form-label" for="feedback-input">Your message</label>
        <textarea class="form-textarea" id="feedback-input" rows="4" maxlength="1000" placeholder="Describe your suggestion, question, or issue..."></textarea>
        <div class="form-footer">
          <span class="char-count"><span id="char-count">0</span> / 1000</span>
          <button class="submit-btn" id="submit-btn">Send Feedback</button>
        </div>
      </section>
      
      <section class="feedback-list-section" aria-label="User feedback and responses">
        <header class="messages-header">
          <h2 class="messages-title">Community Feedback</h2>
          <span class="messages-count" id="messages-count"></span>
        </header>
        <div id="messages-list" role="feed" aria-label="Feedback messages">
          <p class="loading">Loading messages...</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <span style="font-size:0.875rem;color:#9ca3af;">&copy; 2026 PictriKit</span>
      <div style="display:flex;gap:1.5rem;">
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="/contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ========== DOM Elements (获取一次，不重复) ==========
    var input = document.getElementById('feedback-input');
    var charCount = document.getElementById('char-count');
    var submitBtn = document.getElementById('submit-btn');
    var messagesList = document.getElementById('messages-list');
    var messagesCount = document.getElementById('messages-count');
    var toast = document.getElementById('toast');
    var adminBadge = document.getElementById('admin-badge');
    
    // ========== State (只在此处声明) ==========
    var feedbackData = [];
    var isAdmin = false;
    var adminToken = null;
    
    // ========== 工具函数 ==========
    function generateUsername() {
      var adj = ['Happy', 'Swift', 'Clever', 'Bright', 'Cool', 'Quick', 'Smart', 'Calm', 'Bold', 'Kind'];
      var noun = ['Panda', 'Eagle', 'Tiger', 'Fox', 'Wolf', 'Bear', 'Hawk', 'Lion', 'Owl', 'Deer'];
      return adj[Math.floor(Math.random() * adj.length)] + noun[Math.floor(Math.random() * noun.length)] + Math.floor(Math.random() * 1000);
    }
    
    function getUserId() {
      var id = localStorage.getItem('pictrikit_user_id');
      if (!id) {
        id = generateUsername();
        localStorage.setItem('pictrikit_user_id', id);
      }
      return id;
    }
    
    function showToast(msg, type) {
      toast.textContent = msg;
      toast.className = 'toast show' + (type === 'error' ? ' error' : '');
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }
    
    function formatDate(ts) {
      if (!ts) return '';
      try {
        var d = new Date(ts);
        if (isNaN(d.getTime())) return '';
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } catch (e) {
        return '';
      }
    }
    
    function getInitials(name) {
      return (name || 'AN').slice(0, 2).toUpperCase();
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    // ========== Admin Mode 初始化 (只执行一次，在 render 之后调用) ==========
    function initAdminMode() {
      // 检查 URL 参数
      var urlParams = new URLSearchParams(window.location.search);
      var adminTokenFromUrl = urlParams.get('admin');
      if (adminTokenFromUrl) {
        localStorage.setItem('pictrikit_admin_token', adminTokenFromUrl);
        window.history.replaceState({}, '', window.location.pathname);
      }
      
      // 从 localStorage 读取 token
      adminToken = localStorage.getItem('pictrikit_admin_token');
      if (adminToken && adminToken.length > 0) {
        isAdmin = true;
        document.body.classList.add('admin-mode');
        adminBadge.style.display = 'inline-flex';
      }
    }
    
    // ========== API 操作 ==========
    function fetchFeedback() {
      return fetch('/api/feedback')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success && data.feedback) {
            return data.feedback;
          }
          return [];
        })
        .catch(function(e) {
          console.error('Fetch error:', e);
          return [];
        });
    }
    
    function deleteFeedback(id) {
      if (!confirm('Delete this message?')) return;
      fetch('/api/feedback', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
        body: JSON.stringify({ feedbackId: id })
      }).then(function(res) {
        if (res.ok) {
          showToast('Message deleted');
          reloadFeedback();
        } else {
          showToast('Delete failed', 'error');
        }
      }).catch(function() {
        showToast('Delete failed', 'error');
      });
    }
    
    function submitReply(id, btn) {
      var form = btn.closest('.admin-reply-form');
      var textarea = form.querySelector('textarea');
      var reply = textarea.value.trim();
      
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      fetch('/api/feedback', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
        body: JSON.stringify({ feedbackId: id, reply: reply || null })
      }).then(function(res) {
        if (res.ok) {
          showToast(reply ? 'Reply saved' : 'Reply removed');
          reloadFeedback();
        } else {
          showToast('Reply failed', 'error');
        }
      }).catch(function() {
        showToast('Reply failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Save Reply';
      });
    }
    
    // ========== UI 渲染 (只更新子节点，不整体覆盖) ==========
    function toggleReplyForm(id) {
      var card = document.querySelector('[data-id="' + id + '"]');
      if (!card) return;
      
      var existingForm = card.querySelector('.admin-reply-form');
      if (existingForm) {
        existingForm.remove();
        return;
      }
      
      // 关闭其他回复框
      var allForms = document.querySelectorAll('.admin-reply-form');
      for (var i = 0; i < allForms.length; i++) {
        allForms[i].remove();
      }
      
      // 查找当前回复内容
      var item = null;
      for (var j = 0; j < feedbackData.length; j++) {
        if (feedbackData[j].id === id) {
          item = feedbackData[j];
          break;
        }
      }
      var currentReply = item ? (item.reply || '') : '';
      
      // 创建回复表单 (DOM 操作，不用 innerHTML 覆盖整个容器)
      var form = document.createElement('div');
      form.className = 'admin-reply-form';
      
      var textarea = document.createElement('textarea');
      textarea.rows = 4;
      textarea.maxLength = 2000;
      textarea.placeholder = 'Write your official reply...';
      textarea.value = currentReply;
      
      var actions = document.createElement('div');
      actions.className = 'admin-reply-form-actions';
      
      var cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = function() { form.remove(); };
      
      var saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.type = 'button';
      saveBtn.textContent = 'Save Reply';
      saveBtn.onclick = function() { submitReply(id, this); };
      
      actions.appendChild(cancelBtn);
      actions.appendChild(saveBtn);
      form.appendChild(textarea);
      form.appendChild(actions);
      card.appendChild(form);
      textarea.focus();
    }
    
    function renderFeedback(messages) {
      feedbackData = messages;
      
      if (!messages || messages.length === 0) {
        messagesList.innerHTML = '<div class="empty-state"><span class="material-icons-round">chat_bubble_outline</span><p>No messages yet. Be the first to share feedback!</p></div>';
        messagesCount.textContent = '';
        return;
      }
      
      // 过滤可见消息
      var visibleMessages = [];
      for (var i = 0; i < messages.length; i++) {
        if (!messages[i].deleted || isAdmin) {
          visibleMessages.push(messages[i]);
        }
      }
      
      messagesCount.textContent = visibleMessages.length + ' message' + (visibleMessages.length !== 1 ? 's' : '');
      
      // 构建完整 HTML (一次性渲染，包含 admin UI)
      var html = '';
      for (var i = 0; i < visibleMessages.length; i++) {
        var m = visibleMessages[i];
        
        // 官方回复
        var replyHtml = '';
        if (m.reply) {
          replyHtml = '<aside class="reply-card"><header class="reply-header"><span class="creator-badge">Official</span><h4 class="reply-name">PictriKit Team</h4></header><p class="reply-content">' + escapeHtml(m.reply) + '</p></aside>';
        }
        
        // Admin 操作按钮 (只在 isAdmin 时渲染)
        var adminHtml = '';
        if (isAdmin) {
          adminHtml = '<div class="admin-actions"><button class="admin-btn reply-btn" data-action="reply" data-id="' + m.id + '"><span class="material-icons-round">reply</span>' + (m.reply ? 'Edit Reply' : 'Add Reply') + '</button><button class="admin-btn delete-btn" data-action="delete" data-id="' + m.id + '"><span class="material-icons-round">delete</span>Delete</button></div>';
        }
        
        html += '<article class="message-card' + (m.deleted ? ' deleted' : '') + '" data-id="' + m.id + '"><header class="message-header"><div class="message-user"><div class="user-avatar">' + getInitials(m.username) + '</div><h3 class="user-name">' + escapeHtml(m.username || 'Anonymous') + '</h3>' + (m.deleted ? '<span style="color:#dc2626;font-size:0.75rem;">(deleted)</span>' : '') + '</div><time class="message-time">' + formatDate(m.created_at) + '</time></header><div class="message-body"><p class="message-content">' + escapeHtml(m.content) + '</p></div>' + replyHtml + adminHtml + '</article>';
      }
      
      // 一次性设置 innerHTML (不会重复覆盖)
      messagesList.innerHTML = html;
      
      // 绑定事件
      bindAdminEvents();
    }
    
    function bindAdminEvents() {
      if (!isAdmin) return;
      
      var replyBtns = messagesList.querySelectorAll('[data-action="reply"]');
      for (var k = 0; k < replyBtns.length; k++) {
        (function(btn) {
          btn.onclick = function() { toggleReplyForm(btn.dataset.id); };
        })(replyBtns[k]);
      }
      
      var deleteBtns = messagesList.querySelectorAll('[data-action="delete"]');
      for (var l = 0; l < deleteBtns.length; l++) {
        (function(btn) {
          btn.onclick = function() { deleteFeedback(btn.dataset.id); };
        })(deleteBtns[l]);
      }
    }
    
    // ========== 重新加载 (用于提交/删除后) ==========
    function reloadFeedback() {
      fetchFeedback().then(function(data) {
        renderFeedback(data);
      });
    }
    
    // ========== 事件绑定 ==========
    function bindFormEvents() {
      // 字符计数
      input.addEventListener('input', function() {
        charCount.textContent = input.value.length;
      });
      
      // 提交反馈
      submitBtn.addEventListener('click', function() {
        var content = input.value.trim();
        if (content.length < 3) {
          showToast('Please enter at least 3 characters', 'error');
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        
        fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content, username: getUserId() })
        }).then(function(res) {
          return res.json();
        }).then(function(data) {
          if (data.success) {
            showToast('Thanks for your feedback!');
            input.value = '';
            charCount.textContent = '0';
            reloadFeedback();
          } else {
            showToast(data.error || 'Failed to send', 'error');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send Feedback';
        }).catch(function() {
          showToast('Network error', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send Feedback';
        });
      });
    }
    
    // ========== 初始化入口 (严格顺序) ==========
    async function initFeedback() {
      // 1. 先初始化 Admin Mode (读取 localStorage)
      initAdminMode();
      
      // 2. 获取数据
      var feedback = await fetchFeedback();
      
      // 3. 渲染 (isAdmin 已确定，一次性渲染完整 UI)
      renderFeedback(feedback);
      
      // 4. 绑定表单事件
      bindFormEvents();
    }
    
    // 启动
    initFeedback();
  });
  </script>
</body>
</html>
